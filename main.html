<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ClickGame</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0; /* 要素の外側の余白 */
            overflow: hidden; /* はみ出した要素を隠す、スクロールを無効化 */
        }

        /* 上：ゲーム画面（60%） */
        #gameContainer {
            height: 60vh;
            position: relative;
            background: #eef;
            overflow: hidden;
        }

        #btn {
            position: absolute; /* ←これがないと動かせない */
            padding: 0px 0px;
            font-size: 20px;
            cursor: pointer; /* マウスカーソルを指の形にする */
            background: transparent; /* 背景を透明に */
            border: none;             /* 枠線を消す */
        }

        button img {
            width: 100px;
            height: 100px;
        }

        .flyClone{
            position: absolute;
            width: 100px;
            height: 100px;
        }

        .cat-paw {
            position: absolute;
            width: 160px; /* 叩くときに75%(120px) */
            height: auto; /* 1280px */
            z-index: 5; /* 重なり順(UIの後ろ) */
            pointer-events: none; /* クリックを邪魔しない */
            transform: translate(-50%, -50%); /* 指定座標に中心寄せ */
            opacity: 0; /* 透明度(0 or 1) */
            transition: 
                opacity 0.1s ease-in, /* 透明度変更を 0.1 秒, 遅→速 */
                transform 0.1s ease-in;
        }

        .comboText {
            position: absolute;
            font-size: 25px;
            z-index: 6;
            pointer-events: none;
            transform: translate(-50%, -50%); /* 指定座標に中心寄せ */
            opacity: 0;
            transition: 
                opacity 0.4s ease, /* 透明度変更を 0.4 秒, ふわっと */
                transform 0.4s ease;
        }

        #statusBox {
            position: absolute;
            right: 10px; /* 親要素の右端から */
            bottom: 10px; /* 親要素の下端から */
            background: rgba(255,255,255,0.8);
            padding: 8px 12px;
            border-radius: 8px;
            text-align: right;
            align-items: center;
            z-index: 10; /* 重なり順(最前面) */
            pointer-events: none; /* ←クリックを邪魔しない */
            font-size: 18px;
        }

        #comboGauge {
            width: 60px;
            height: 60px;
        }

        /* 下：グラフ（40%） */
        #graphContainer {
            height: 40vh;
            width: 100vw;
            padding: 10px;
            background: #fafafa;
            box-sizing: border-box;
        }

        #chartCanvas {
            width: 100%; /* 親要素と同じ大きさにする */
            height: 100%;
        }
    </style>
</head>

<body>

    <!-- 上：ゲーム部分 -->
    <div id="gameContainer">
        <button id="btn", onclick="clicked()">
            <img src="realisticFly.png" alt="ハエ">
        </button>
        <div id="statusBox">
            <canvas id="comboGauge" width="60" height="60"></canvas>
            <div id="scoreDisplay">Score: 0</div>
            <div id="comboDisplay">Combo: 0</div>
        </div>
    </div>

    <!-- 下：グラフ部分 -->
    <div id="graphContainer">
        <canvas id="chartCanvas"></canvas>
    </div>

<script>
/* =======================
      ゲーム（ボタンクリック）
======================= */
const btn = document.getElementById("btn");
const gameContainer = document.getElementById("gameContainer");
const gaugeCanvas = document.getElementById("comboGauge");
const gctx = gaugeCanvas.getContext("2d");

let score = 0;
let scoreVel = 0;
let lastClickTime = 0;
let combo = 0;
let comboLimit = 3000; // ミリ秒

let gravity = 9.8;
const frameRate = 10 // 毎秒
let lastTime = Date.now(); // フレーム間の正確な時間測定用

function updateStatus() {
    document.getElementById("scoreDisplay").textContent = "Score: " + Math.floor(score);
    document.getElementById("comboDisplay").textContent = "Combo: " + combo;
}

// ボタンをランダム位置へ動かす関数
function setRandomPosition() {
    const box = document.getElementById("statusBox");
    const boxW = box.offsetWidth;
    const boxH = box.offsetHeight;

    const maxX = gameContainer.clientWidth - btn.offsetWidth - boxW - 10;
    const maxY = gameContainer.clientHeight - btn.offsetHeight - boxH - 10;

    const x = Math.random() * maxX; /* ボタン左端座標 */
    const y = Math.random() * maxY; /* ボタン上端座標 */

    btn.style.left = x + "px"; /* インラインCSSでスタイル「left: 〇〇px;」を指定 */
    btn.style.top = y + "px";
}

function showComboText(x, y, combo) {
    const comboText = document.createElement("div")
    comboText.textContent = `${combo+1}コンボ！` // comboが増える前の処理なので+1
    comboText.className = "comboText"

    comboText.style.left = x + "px";
    comboText.style.top = y + "px";
    comboText.style.transform = `translate(-50%, -50%)`;
    gameContainer.appendChild(comboText);

    requestAnimationFrame(() => {
        comboText.style.opacity = 1;
        comboText.style.transform = `translate(-50%, -50%) scale(0.8)`;
    });

    setTimeout(() => {
        comboText.style.opacity = 0;
        comboText.style.transform = `translate(-50%, -50%) scale(1.5)`;
    }, 600);

    setTimeout(() => comboText.remove(), 1000);
}

function showCatPaw(x, y) {
    const flyClone = document.createElement("img")
    flyClone.src = "realisticFly.png";
    flyClone.className = "flyClone";
    const paw = document.createElement("img");
    paw.src = "catHand.png";
    paw.className = "cat-paw";

    const distance = 200;

    // 0 ~ 2π rad
    const angle = Math.random() * Math.PI * 2; /* 右が 0 rad */

    // 距離1を2軸に分解し、距離をかける
    const dx = Math.cos(angle) * distance;
    const dy = Math.sin(angle) * distance;

    paw.style.left = x + "px";
    paw.style.top = y + "px";
    paw.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) rotate(${angle - Math.PI/2}rad)`;
    flyClone.style.left = x + "px";
    flyClone.style.top = y + "px";
    flyClone.style.transform = `translate(-50%, -50%)`;

    gameContainer.appendChild(flyClone);
    gameContainer.appendChild(paw);

    requestAnimationFrame(() => {
        paw.style.opacity = 1;
        paw.style.transform = `translate(-50%, -50%) scale(0.75, 0.75) rotate(${angle - Math.PI/2}rad)`;
    });
    setTimeout(() => {
        paw.style.opacity = 1;
        paw.style.transform = `translate(calc(-50% + ${dx/distance*10}px), calc(-50% + ${dy/distance*10}px)) scale(0.75, 0.75) rotate(${angle - Math.PI/2}rad)`;
    }, 100);

    // 少し待ってフェードアウト
    setTimeout(() => {
        paw.style.opacity = 0;
        paw.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) rotate(${angle - Math.PI/2}rad)`;
    }, 400);

    // 完全に消す
    setTimeout(() => flyClone.remove(), 100)
    setTimeout(() => paw.remove(), 800);
}

// クリックされたらスコアアップ＋移動
function clicked() {
    const now = Date.now();
    showComboText(
        btn.offsetLeft + btn.offsetWidth / 2,
        btn.offsetTop + btn.offsetHeight / 2,
        combo
    )
    showCatPaw(
        btn.offsetLeft + btn.offsetWidth / 2,
        btn.offsetTop + btn.offsetHeight / 2
    );

    if (now - lastClickTime <= comboLimit || combo == 0) {
        combo++;
    }
    // scoreVel に combo を足す (9.8以上98以下)
    scoreVel = Math.max(
        gravity,
        Math.min(
            scoreVel + Math.floor(combo/5),
            gravity*10
        )
    )
    lastClickTime = now;
    updateStatus();
    setRandomPosition();
}

setRandomPosition(); // 最初の位置

/* =======================
      グラフ（リアルタイム更新）
======================= */
const ctx = document.getElementById("chartCanvas").getContext("2d");

let labels = [0];
let data = [0];

const chart = new Chart(ctx, {
    type: "line",
    data: {
        labels,
        datasets: [{
            label: "Click Score",
            data,
            borderWidth: 2
        }]
    },
    options: {
        animation: false, /* プロット追加時のアニメーション */
        responsive: true, /* グラフ自動調整 */
        maintainAspectRatio: false,
        scales: { 
            x: {
                ticks: {
                    display: false // ★ 横軸の数字を非表示
                }
            },
            y: { 
                beginAtZero: true 
            } 
        }
    }
});

// スコアが変わったらグラフにも追加
function addScoreToGraph(value) {
    labels.push(labels.length);
    data.push(value);

    while (labels.length > 50) {
        labels.shift(); /* リストの 「先頭」 を1つ消す */
        data.shift();
    }

    const values = chart.data.datasets[0].data; /* 1つめのデータセットの値すべて */

    chart.options.scales.y.max = Math.max(...values, 10);

    chart.update();
}

function drawComboGauge() {
    const now = Date.now();
    const elapsed = now - lastClickTime;

    // 残り割合（1.0 → 0.0）
    let ratio = 1 - elapsed / comboLimit;
    if (ratio < 0) ratio = 0;

    const center = 30; // canvas 60 の半分
    const radius = 24; // 外側 - 太さ/2 (= 内側の半径)

    gctx.clearRect(0, 0, 60, 60); // x, y, width, height

    // 背景円
    gctx.beginPath();
    gctx.arc(center, center, radius, 0, Math.PI * 2); // x, y, radius, startAngle, endAngle
    gctx.strokeStyle = "#ddd";
    gctx.lineWidth = 10;
    gctx.stroke();

    // コンボ残りゲージ
    gctx.beginPath();
    gctx.arc(
        center,
        center,
        radius,
        -Math.PI / 2,
        -Math.PI / 2 + Math.PI * 2 * ratio
    );
    gctx.strokeStyle = "#ff9800";
    gctx.lineWidth = 6;
    gctx.stroke();
}

setInterval(() => {
    const now = Date.now();
    const deltaTime = (now - lastTime) / 1000; // 秒
    lastTime = now;
    if (now - lastClickTime > comboLimit) {
        combo = 0;
    }

    // 減衰量の計算
    scoreVel -= gravity * deltaTime;
    score += scoreVel * deltaTime;

    if (score <= 0) {
        score = 0;
        scoreVel = 0;
    }

    updateStatus();
    // グラフに追加
    addScoreToGraph(score);
    drawComboGauge();
}, 1000/frameRate);

</script>
</body>
</html>
