<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ClickGame</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0; /* 要素の外側の余白 */
            overflow: hidden; /* はみ出した要素を隠す、スクロールを無効化 */
        }

        /* 上：ゲーム画面（60%） */
        #gameContainer {
            height: 60vh;
            position: relative;
            background: #eef;
        }

        #btn {
            position: absolute; /* ←これがないと動かせない */
            padding: 0px 0px;
            font-size: 20px;
            cursor: pointer; /* マウスカーソルを指の形にする */
            background: transparent; /* 背景を透明に */
            border: none;             /* 枠線を消す */
        }

        button img {
            width: 100px;
            height: 100px;
        }

        #statusBox {
            position: absolute;
            right: 10px; /* 親要素の右端から10px */
            bottom: 10px; /* 親要素の下端から10px */
            background: rgba(255,255,255,0.8);
            padding: 8px 12px;
            border-radius: 8px;
            text-align: right;
            align-items: center;
            pointer-events: none; /* ←クリックを邪魔しない */
            font-size: 18px;
        }

        #comboGauge {
            width: 60px;
            height: 60px;
        }

        /* 下：グラフ（40%） */
        #graphContainer {
            height: 40vh;
            width: 100vw;
            padding: 10px;
            background: #fafafa;
            box-sizing: border-box;
        }

        #chartCanvas {
            width: 100%; /* 親要素と同じ大きさにする */
            height: 100%;
        }
    </style>
</head>

<body>

    <!-- 上：ゲーム部分 -->
    <div id="gameContainer">
        <button id="btn", onclick="clicked()">
            <img src="realisticFly.png" alt="ハエ">
        </button>
        <div id="statusBox">
            <canvas id="comboGauge" width="60" height="60"></canvas>
            <div id="scoreDisplay">Score: 0</div>
            <div id="comboDisplay">Combo: 0</div>
        </div>
    </div>

    <!-- 下：グラフ部分 -->
    <div id="graphContainer">
        <canvas id="chartCanvas"></canvas>
    </div>

<script>
/* =======================
      ゲーム（ボタンクリック）
======================= */
const btn = document.getElementById("btn");
const gameContainer = document.getElementById("gameContainer");
const gaugeCanvas = document.getElementById("comboGauge");
const gctx = gaugeCanvas.getContext("2d");

let score = 0;
let now = Date.now();
let lastClickTime = Date.now();
let combo = 0;
let comboLimit = 3000; // 3秒

function updateStatus() {
    document.getElementById("scoreDisplay").textContent = "Score: " + Math.floor(score);
    document.getElementById("comboDisplay").textContent = "Combo: " + combo;
}

// ボタンをランダム位置へ動かす関数
function setRandomPosition() {
    const box = document.getElementById("statusBox");
    const boxW = box.offsetWidth;
    const boxH = box.offsetHeight;

    const maxX = gameContainer.clientWidth - btn.offsetWidth - boxW - 10;
    const maxY = gameContainer.clientHeight - btn.offsetHeight - boxH - 10;

    const x = Math.random() * maxX; /* ボタン左端座標 */
    const y = Math.random() * maxY; /* ボタン上端座標 */

    btn.style.left = x + "px"; /* インラインCSSでスタイル「left: 〇〇px;」を指定 */
    btn.style.top = y + "px";
}

// クリックされたらスコアアップ＋移動
function clicked() {
    if (now - lastClickTime <= comboLimit) {
        combo++;
    }
    score += 1 + Math.floor(combo/5);
    lastClickTime = now;
    updateStatus();
    setRandomPosition();
    addScoreToGraph(score);
}

setRandomPosition(); // 最初の位置

/* =======================
      グラフ（リアルタイム更新）
======================= */
const ctx = document.getElementById("chartCanvas").getContext("2d");

let labels = [0];
let data = [0];

const chart = new Chart(ctx, {
    type: "line",
    data: {
        labels,
        datasets: [{
            label: "Click Score",
            data,
            borderWidth: 2
        }]
    },
    options: {
        animation: false, /* プロット追加時のアニメーション */
        responsive: true, /* グラフ自動調整 */
        maintainAspectRatio: false,
        scales: { 
            x: {
                ticks: {
                    display: false // ★ 横軸の数字を非表示
                }
            },
            y: { 
                beginAtZero: true 
            } 
        }
    }
});

// スコアが変わったらグラフにも追加
function addScoreToGraph(value) {
    labels.push(labels.length);
    data.push(value);

    while (labels.length > 50) {
        labels.shift(); /* リストの 「先頭」 を1つ消す */
        data.shift();
    }

    const values = chart.data.datasets[0].data; /* 1つめのデータセットの値すべて */

    chart.options.scales.y.max = Math.max(...values, 10);

    chart.update();
}

function drawComboGauge() {
    const now = Date.now();
    const elapsed = now - lastClickTime;

    // 残り割合（1.0 → 0.0）
    let ratio = 1 - elapsed / comboLimit;
    if (ratio < 0) ratio = 0;

    const center = 30; // canvas 60 の半分
    const radius = 24; // 外側 - 太さ/2 (= 内側の半径)

    gctx.clearRect(0, 0, 60, 60); // x, y, width, height

    // 背景円
    gctx.beginPath();
    gctx.arc(center, center, radius, 0, Math.PI * 2); // x, y, radius, startAngle, endAngle
    gctx.strokeStyle = "#ddd";
    gctx.lineWidth = 10;
    gctx.stroke();

    // コンボ残りゲージ
    gctx.beginPath();
    gctx.arc(
        center,
        center,
        radius,
        -Math.PI / 2,
        -Math.PI / 2 + Math.PI * 2 * ratio
    );
    gctx.strokeStyle = "#ff9800";
    gctx.lineWidth = 6;
    gctx.stroke();
}

setInterval(() => {
    now = Date.now();
    const elapsed = (now - lastClickTime) / 1000; // 経過秒数

    if (now - lastClickTime > comboLimit) {
        combo = 0;
    }

    // 減衰量の計算（好みで調整）
    const decaySpeed = 0.5*Math.min(score, 100)/100; //減衰率0.5(スコア100までは減衰ポイントを軽減)
    const decrease = elapsed * decaySpeed;

    score -= decrease;

    if (score < 0) score = 0;

    updateStatus();
    // グラフに追加
    addScoreToGraph(score);
    drawComboGauge();
}, 100);

</script>
</body>
</html>
